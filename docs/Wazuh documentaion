# Wazuh SOC Lab with pfSense
**Full Build & Integration Guide**

## ğŸ“‹ Objective
Build a complete SOC lab where:
- âœ… pfSense acts as firewall + router
- âœ… Kali is the attacker
- âœ… Windows & Ubuntu are victims
- âœ… Wazuh collects logs and shows alerts in dashboard

All traffic flows through pfSense and all logs are monitored by Wazuh.

---

## ğŸ–¥ï¸ Virtual Machines

| VM | Purpose |
|---|---|
| **pfSense** | Firewall, Router, DHCP, NAT |
| **Ubuntu (Wazuh Server)** | SIEM server |
| **Lubuntu (Agent)** | Linux monitored host |
| **Windows 10** | Windows monitored host |
| **Kali Linux** | Attacker |

---

## ğŸŒ Network Architecture

### VirtualBox Network Design

| VM | Adapter Configuration |
|---|---|
| **pfSense** | Adapter 1 â†’ NAT<br>Adapter 2 â†’ Host-Only |
| **All Others** | Adapter 1 â†’ Host-Only |

---

## âš™ï¸ VirtualBox Host-Only Network Setup

1. Open: **VirtualBox â†’ File â†’ Tools â†’ Host Network Manager**
2. Create a Host-Only network
3. Configure:
   - **IPv4:** `192.168.56.1`
   - **Mask:** `255.255.255.0`
   - **DHCP:** Disabled

> pfSense will provide DHCP instead

---

## ğŸ”§ pfSense Configuration

### Interfaces
- **WAN** â†’ NAT
- **LAN** â†’ Host-Only

### Enable DHCP
**pfSense Web UI:** Services â†’ DHCP Server â†’ LAN

Enable DHCP with:
- **Range:** `192.168.56.50 â€“ 192.168.56.150`
- **Gateway:** `192.168.56.1`
- **DNS:** `8.8.8.8`

### NAT
**Firewall â†’ NAT â†’ Outbound â†’ Automatic**

---

## ğŸ§ Ubuntu Wazuh Server IP Configuration

**Set static IP:** `192.168.56.10`

**Netplan configuration:**

```yaml
network:
  version: 2
  renderer: NetworkManager
  ethernets:
    enp0s3:
      dhcp4: no
      addresses:
        - 192.168.56.10/24
      routes:
        - to: default
          via: 192.168.56.1
      nameservers:
        addresses:
          - 8.8.8.8
```

---

## ğŸ“¦ Wazuh Installation

**On Wazuh Server, install:**
- âœ… Wazuh Manager
- âœ… Wazuh Indexer
- âœ… Wazuh Dashboard

---

## ğŸ” Agent Registration

### On Wazuh Server
```bash
sudo /var/ossec/bin/manage_agents
```

**Add agents:**
- windows
- ubuntu

**Extract keys**

### On Ubuntu Agent
```bash
sudo /var/ossec/bin/manage_agents
```
- Select **I** â†’ paste key â†’ **Q**
```bash
sudo systemctl restart wazuh-agent
```

### On Windows Agent
**Run as Admin:**
```cmd
manage_agents.exe
```
- Select **I** â†’ paste key â†’ **Q**
- Restart **Wazuh Agent** service

---

## âœ… Verify Agents

**On Wazuh Server:**
```bash
/var/ossec/bin/agent_control -lc
```

**Expected output:**
- âœ… windows â†’ Active
- âœ… ubuntu â†’ Active

---

## ğŸ§ª Log Flow Test

### Linux Test
```bash
su root
# Enter wrong password
```

**Dashboard:**
- Wazuh â†’ Security Events â†’ Authentication failure

### Windows Test
- Attempt wrong login â†’ Event ID 4625

---

## ğŸ”¥ pfSense Logs

**pfSense sends syslog to Wazuh**

Logs appear in Wazuh Dashboard

---

## ğŸ—ï¸ Final SOC Architecture

```
Kali â†’ attacks
Windows & Ubuntu â†’ victims
pfSense â†’ firewall + router
Wazuh â†’ SIEM
Dashboard â†’ visualization
```

---

## ğŸ“Š Architecture Flow

```
[Internet]
    â†“
[pfSense WAN]
    â†“
[pfSense LAN] â† 192.168.56.1
    â†“
    â”œâ”€â”€ [Wazuh Server] - 192.168.56.10
    â”œâ”€â”€ [Windows 10] - DHCP
    â”œâ”€â”€ [Lubuntu] - DHCP
    â””â”€â”€ [Kali Linux] - DHCP
```

---

**ğŸ¯ Lab Complete!**
